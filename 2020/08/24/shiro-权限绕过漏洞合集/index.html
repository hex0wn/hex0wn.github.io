<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>shiro 权限绕过漏洞合集 | Hexo</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/component.css" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <meta name="generator" content="Hexo">
  <script src="http://static.duoshuo.com/embed.js"></script>
  
  
  

  

</head>
<body>
<div class="container">
    <div class="mp-pusher" id="mp-pusher">
        <i id="scroll-up" class="fa fa-angle-up"></i>
        <nav id="mp-menu" class="mp-menu">
            <div class="mp-level">
                <a data-pjax class="back-home" style="font-size: 20px" href="/"><h2 ><i class="fa fa-home"></i>
                        Home</h2></a>
                <ul class="first-level">
                    <li>
                        <a class="fa fa-archive" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Archive</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-archive"></i>
                                Archive</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-archive" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/11/15/fastjson-反序列化漏洞整理/">fastjson 反序列化漏洞整理</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/11/15/Thymeleaf-模板漏洞分析/">Thymeleaf 模板漏洞分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/08/24/JDK多版本切换/">JDK多版本切换</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/08/24/shiro-权限绕过漏洞合集/">shiro 权限绕过漏洞合集</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE复现分析/">CVE-2020-5902 F5 BIG-IP RCE复现分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/08/06/Laravel-Cookie-Security漏洞分析/">Laravel Cookie Security漏洞分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/04/25/git-CVE-2020-5260分析/">git CVE-2020-5260分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/04/25/hello-world/">Hello World</a>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-copy" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Categories</a>

                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-copy"></i>
                                Categories</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-category" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-tags" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Tags</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-tags"></i>
                                Tags</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-tag" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    
                    <li class="mp-pjax"><a class="fa fa-user" href="/about">&nbsp;&nbsp;&nbsp;About me</a></li>
                    <li><a class="fa fa-github" href="#">&nbsp;&nbsp;&nbsp;Github</a></li>

                </ul>

            </div>
        </nav>
        <div id="pjax">
            <div class="pjax-hidden" style="display: none">
                
                    <a  data-pjax href="/2020/11/15/fastjson-反序列化漏洞整理/">fastjson 反序列化漏洞整理</a>
                
                    <a  data-pjax href="/2020/11/15/Thymeleaf-模板漏洞分析/">Thymeleaf 模板漏洞分析</a>
                
                    <a  data-pjax href="/2020/08/24/JDK多版本切换/">JDK多版本切换</a>
                
                    <a  data-pjax href="/2020/08/24/shiro-权限绕过漏洞合集/">shiro 权限绕过漏洞合集</a>
                
                    <a  data-pjax href="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE复现分析/">CVE-2020-5902 F5 BIG-IP RCE复现分析</a>
                
                    <a  data-pjax href="/2020/08/06/Laravel-Cookie-Security漏洞分析/">Laravel Cookie Security漏洞分析</a>
                
                    <a  data-pjax href="/2020/04/25/git-CVE-2020-5260分析/">git CVE-2020-5260分析</a>
                
                    <a  data-pjax href="/2020/04/25/hello-world/">Hello World</a>
                
                
                
                <a data-pjax class="fa fa-user" href="/about">&nbsp;&nbsp;&nbsp;About me</a>
            </div>
            <nav class="nexus">
                <li  style="border-left: 1px solid #c6d0da;">
                    <a id="trigger" href="#"><i class="fa fa-bars"></i></a>
                </li>
                <li ><a id="nexus-back" data-pjax href="/">Hexo</a></li>
                
                <div id="nav-container">
                    <div class="post-navbar" style="line-height: 63px;display:none">
                        <li id="navbar-title"><a href="#">shiro 权限绕过漏洞合集</a></li>
                        <li id="navbar-toc" style="border-left: none">
                            <a style="padding-right: 15px">
                                <span id="toc-content" >Introduction</span><i class="fa fa-chevron-down" ></i>
                            </a>
                            <div class="hidden-box">
                                <ul id="toc"></ul>
                            </div>
                        </li>
                    </div>
                </div>
                
            </nav>

            <div class="scroller">
            <div class="scroller-inner">


<!-- -->
<!--<body class="post-template">-->
<!---->
  

<main class="content" role="main">
    <article class="post" >
    <span class="post-meta">
                  <div class="tag-tile">
                      
                  </div>
                <h1 class="post-title" style="margin: 14px 0;color:#50585D">shiro 权限绕过漏洞合集</h1>

                    <div class="post-meta">
                        Post on<span class="fa fa-clock-o"></span>
                        <time datetime="2020-08-24T13:10:01.000Z"
                              itemprop="datePublished">2020-08-24</time>
                    </div>
    </span>

        <section class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>近期shiro多次对权限绕过问题进行了修复，在此对相关漏洞进行学习分析，了解整个修复过程中的安全对抗策略。<br>本地环境：idea + <a href="https://github.com/hex0wn/learn-java-bug/tree/master/shiro-auth" target="_blank" rel="noopener">shirodemo</a> 项目代码</p>
<h2 id="CVE-2020-1957"><a href="#CVE-2020-1957" class="headerlink" title="CVE-2020-1957"></a>CVE-2020-1957</h2><h3 id="版本-lt-1-5-0"><a href="#版本-lt-1-5-0" class="headerlink" title="版本&lt;1.5.0"></a>版本&lt;1.5.0</h3><p>有人在github上提交pr表示可以通过在末尾增加/，绕过shiro的权限认证。 随后官方对这个pr进行了合并，发布了版本1.5.0。<br>使用修复前的最后一个版本1.4.2进行测试，配置的路径拦截规则如下：  </p>
<blockquote>
<p>map.put(“/doLogin”, “anon”);<br>        map.put(“/hello/*”, “authc”);<br>        bean.setFilterChainDefinitionMap(map);  </p>
</blockquote>
<p>顺利通过 <code>/hello/a/</code> 绕过权限限制</p>
<p>调试看看漏洞现场的具体情况，根据补丁信息把断点打在PathMatchingFilter.pathsMatch和PathMatchingFilterChainResolver.getChain函数。<br>程序运行后停在getChain函数中，它调用getPathWithinApplication获取URI路径，然后遍历filterChains逐个进行匹配pathMatches  </p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/getchain.png" class="" title="getchain">  


<p>实际的匹配逻辑在方法<code>AntPathMatcher.doMatch</code>，先将<code>pattern</code>和<code>path</code>解析成字符串数组，此时会忽略多余的分隔符<code>/</code>。然后逐项进行匹配，存在<code>**</code>则会跳出循环并且倒序再匹配，在<code>matchString</code>中对<code>*</code>和<code>?</code>进行匹配处理。<br>总结一下ant匹配语法：  </p>
<blockquote>
<p>?：匹配一个字符<br><em>：匹配零个或多个字符串<br>*</em>：匹配路径中的零个或多个路径  </p>
</blockquote>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/domatch1.png" class="">  

<p>正向匹配完所有字符数组，然后会校验pattern和path的末尾的斜线是不是一致。这里校验失败导致绕过了校验</p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/domatch2.png" class="">  

<h3 id="1-5-0补丁"><a href="#1-5-0补丁" class="headerlink" title="1.5.0补丁"></a>1.5.0补丁</h3><p>在调用pathMatches进行匹配查找之前把path和pattern最后的/删除</p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/150patch.png" class=""> 

<h3 id="1-5-0补丁绕过"><a href="#1-5-0补丁绕过" class="headerlink" title="1.5.0补丁绕过"></a>1.5.0补丁绕过</h3><p>由于tomcat的特性，可以通过;来绕过。访问/hello;/aaa/，此时getPathWithinApplication获取到的路径为/hello，导致绕过。</p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/150bypass.png" class=""> 
<p>网传的另外一个PoC <code>/fdsf;/../hello/1</code>，但我在本地复现报404错误</p>
<h3 id="1-5-2补丁"><a href="#1-5-2补丁" class="headerlink" title="1.5.2补丁"></a>1.5.2补丁</h3><p>针对1.5.0的绕过，官方发布了1.5.2版本进行修复。在<code>WebUtils.getRequestUri</code>函数中，原先从<code>request.getRequestURI()</code>获取路径，现在拼接<code>getContextPath</code>、<code>getServletPath</code>、<code>getPathInfo</code>三部分。</p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/152patch.png" class=""> 
<p>至此CVE-2020-1957的生命结束，但新一轮的抗争由此开始。</p>
<h2 id="CVE-2020-11989"><a href="#CVE-2020-11989" class="headerlink" title="CVE-2020-11989"></a>CVE-2020-11989</h2><p>再仔细看看<code>WebUtils.getRequestUri</code>方法，其中会调用<code>decodeAndCleanUriString</code>和<code>normalize</code>对uri进行处理。<br><code>decodeAndCleanUriString</code>先会对uri进行url解码，然后如果存在;则截取前半部分字符串。而normalize则是对<code>\</code>、<code>//</code>、<code>/./</code>、<code>/../</code>进行处理。</p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/decode.png" class=""> 
<p>根据<code>decodeAndCleanUriString</code>就能构造出新的绕过 <code>/hello/%253ba</code>，shiro解析出来的URI是<code>/hello/</code>，与pattern  <code>/hello/*</code>匹配不上。<br>除了通过截断URI还可以通过插入路径分隔符让<code>*</code>匹配不上，使用 <code>/hello/a%252fa</code>，shiro解析到的<code>/hello/a/a</code> 同样也匹配不到 <code>/hello/*</code></p>
<p>1.5.3补丁<br>直接拼接getServletPath和getPathInfo，不再进行解码操作。removeSemicolon函数用来截取分号;</p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/153patch1.png" class=""> 
<p>把1.5.2中对WebUtils.getRequestUri的改动进行了还原，并且标记为Deprecated。getServletPath和getPathInfo只是进行了封装，本质还是从request对象中获取数据</p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/153patch2.png" class=""> 

<h2 id="CVE-2020-13933"><a href="#CVE-2020-13933" class="headerlink" title="CVE-2020-13933"></a>CVE-2020-13933</h2><p>咋一看补丁没什么问题，但仔细想想这里却别有洞天。在<code>getServletPath</code>和<code>getPathInfo</code>之前，tomcat已经对<code>;</code>进行了<code>normalize</code>处理，这里的<code>;</code>其实是url中的<code>%3b</code>，不太明白开发者为什么要在这里处理<code>;</code>。可以继续用<code>%3b</code>截断path来绕过pattern校验，PoC：<code>/hello/%3ba</code>。<br>这个PoC只影响1.5.0到1.5.3版本，但不影响最开始的1.4.2版本。因为1.5.0补丁引入的代码会将path和pattern最后的/删除，导致pathMatches函数中pattern：<code>/hello/*</code> 匹配不到path： <code>/hello/</code>了，中间的多次绕过都利用了这一点。</p>
<h2 id="终局之战"><a href="#终局之战" class="headerlink" title="终局之战"></a>终局之战</h2><p>1.6.0版本的修复方式有点狠，新增<code>InvalidRequestFilter</code>检查<code>getRequestURI()</code>中是否存在黑名单元素<code>(&quot;;&quot;, &quot;%3b&quot;, &quot;%3B&quot; &quot;\\&quot;, &quot;%5c&quot;, &quot;%5C&quot; )</code>以及非打印字符。</p>
<img src="/2020/08/24/shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%90%88%E9%9B%86/160patch.png" class=""> 
<p>修复方式比较有效，但也引入了一个bug。原本客户端没设置cookie的情况下，重定向到登录页时会带参数 <code>/login;jsessionid=xxx</code>，但目前302后会导致请求400 Bad Request。<br>shiro权限绕过的问题也许没有真正落幕，期待下一次绕过的出现。</p>
<p>参考链接<br><a href="https://issues.apache.org/jira/browse/SHIRO-682" target="_blank" rel="noopener">https://issues.apache.org/jira/browse/SHIRO-682</a><br><a href="https://segmentfault.com/a/1190000019440231" target="_blank" rel="noopener">https://segmentfault.com/a/1190000019440231</a><br><a href="https://www.freebuf.com/vuls/231909.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/231909.html</a><br><a href="https://xlab.tencent.com/cn/2020/06/30/xlab-20-002/" target="_blank" rel="noopener">https://xlab.tencent.com/cn/2020/06/30/xlab-20-002/</a></p>

        </section>
        <hr/>
        <nav class="pagination" style="width:auto" role="pagination">
            
            <a data-pjax class="newer-posts" href="/2020/08/24/JDK多版本切换/">← Prev Post</a>
            
            <a class="share-button" data-original-title title>Share this Post</a>
            
            <a data-pjax class="older-posts" href="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE复现分析/">Next Post →</a>
            
        </nav>
        <br/>
        <br/>
        <section id="comment">
            <div id="comment-box"></div>
        </section>


    </article>
</main>


  
<footer class="site-footer">
    
    <div class="inner">
        <section class="copyright"><a href="/"></a> &copy; Hexo 2014</section>
        <section class="poweredby">Published with <a target="_blank" href="http://hexo.io/">Hexo   </a> and Theme by <a target="_blank" href="https://github.com/yuche/hexo-theme-kael">Kael</a></section>
    </div>
</footer>
</div>
</div><!-- /scroller -->

</div><!-- /pusher -->
</div><!-- /container -->
</div>

<!-- Easter eggs -->

<div class="egg animated">
    <a id="close-button" href="#">X</a>
    <div class="block">
        <div class="loading">
            <span class="ball1"></span>
            <span class="ball2"></span>
        </div>
    </div>
</div>
  
<script src="//cdn.staticfile.org/jquery/1.11.0/jquery.min.js"></script>
<script>
    if (!window.jQuery) {
        var script = document.createElement('script');
        script.src = "/js/jquery.min.js";
        document.body.appendChild(script);
    }
</script>
<script type="text/javascript" src="/js/lib.js"></script>
<script type="text/javascript" src="/js/main.js"></script>







</body>
</html>
